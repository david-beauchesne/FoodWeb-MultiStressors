# source('./Code/Figures/F2-Vulnerability.R')
source('./Code/0-Param.R')
source('./Code/Functions/plotMotifs.R')
load('./Data/vulnerability.RData')

# ------------------------------------------------------------------------------
# FIGURE 2
# ------------------------------------------------------------------------------
# Parameters
pos <- c('ttz','tty','ttx','omz','omy','omx','exz','exx','apz','apx','pay','pax','paz','dix')
sep <- c('ttx','omx','exx','apx','paz')

png('./Figures/vulnerability.png', width = 1344, height = 1500, res = 200, pointsize = 6)
# layout(mat, widths = c(.55,.35,1,1), heights = c(.5,rep(1,14)))
par(family = 'serif')

cl <- c(0,.55,.9,1,2,3,4,5)
rw <- c(0,seq(.5, by = 1, length.out = 16)) %>% rev()

# Plot 1
par(mar = c(0,0,0,0))
plot0(x = c(0,4.9), y = c(.5,15.5))

# -------------------------
#        Titles
# -------------------------
# Main
text(x = mean(cl[1:2]), y = rw[1]+.2, labels = 'Motifs', adj = c(.5,.5), cex = 1.25, font = 2)
text(x = mean(cl[2:3]), y = rw[1]+.2, labels = TeX('\\textbf{Positions (\\textit{i})}'), adj = c(.5,.5), cex = 1.25, font = 2)
text(x = mean(cl[4:6]), y = rw[1]+.4, labels = TeX('\\textbf{Trophic sensitivity} ($\\textit{S_{i,K}}$)'), cex = 1.25, adj = c(.5,.5))
text(x = mean(cl[6:7]), y = rw[1]+.4, labels = TeX('\\textbf{Trophic amplification} ($\\textit{A_{i,K}}$)'), cex = 1.25, adj = c(.5,.5))
text(x = mean(cl[7:8]), y = rw[1]+.4, labels = TeX('\\textbf{Variance} ($\\textit{V_{i,K}}$)'), cex = 1.25, adj = c(.5,.5))

# Subtitles
text(x = mean(cl[4:5]), y = rw[1]+.15, labels = 'Unitary pathways', cex = 1, adj = c(.5,.5), font = 2)
text(x = mean(cl[4:5]), y = rw[1]-.075, labels = TeX('\\textbf{of effect} ($k$)'), cex = 1, adj = c(.5,.5), font = 2)
text(x = c(mean(cl[5:6]), mean(cl[6:7]), mean(cl[7:8])), y = rw[1]+.15, labels = rep('Integrative pathways',3), cex = 1, adj = c(.5,.5), font = 2)
text(x = c(mean(cl[5:6]), mean(cl[6:7]), mean(cl[7:8])), y = rw[1]-.075, labels = rep(TeX('\\textbf{of effect} ($K$)'), 3), cex = 1, adj = c(.5,.5), font = 2)

# -------------------------
#        x-axes
# -------------------------
# Axes
nm <- list(seq(-.06,.06,length.out = 5),
           seq(-.15,.15,length.out = 5),
           seq(-.005,.005,length.out = 5),
           seq(0,.01,length.out = 5))
for(j in 4:7) {
  xR <- c(cl[j]+.075, cl[j+1]-.075)
  lines(x = xR, y = rep(1,2))
  lines(x = xR, y = rep(15,2))
  x <- seq(xR[1], xR[2], length.out = 5)
  for(i in 1:5) lines(x = rep(x[i],2), y = c(15,15.1))
  for(i in 1:5) lines(x = rep(x[i],2), y = c(1,.9))
  text(x = x, y = 15.2, labels = nm[[j-3]],adj = c(.5,.5), cex = .75)
  text(x = x, y = .8, labels = nm[[j-3]],adj = c(.5,.5), cex = .75)
}



# -------------------------
#        Motifs
# -------------------------
motifs <- c('tt','om','ex','ap','pa','di')
posY <- c(15,12,9,7,5,2)
lab <- c('Tri-trophic\nfood chain','Omnivory','Exploitative\ncompetition','Apparent\ncompetition','Partially\nconnected','Disconnected')
for(i in 1:length(motifs)) {
  plotMotifs(motifs[i], scalingY = .3, scalingX = .15, x = cl[2]-.1, y = posY[i]-.5, add = T, cex = 1.5)
  text(x = 0, y = posY[i]-.1, labels = lab[i], cex = 1, adj = c(0,1))
}


# -------------------------
#       Positions
# -------------------------
motifs <- c('tt','tt','tt','om','om','om','ex','ex','ap','ap','pa','pa','pa','di') %>% rev()
sp <- c('z','y','x','z','y','x','z','x','z','x','y','x','z','x') %>% rev()
for(i in 1:length(motifs)) {
  plotMotifs(motifs[i], sp[i], add = T, cex = 1.5,
             scalingY = .3, scalingX = .15,
             x = mean(cl[2:3]), y = i+.5)
}

# -------------------------
#  Univariate sensitivity
# -------------------------
for(i in 1:length(pos)) {
  k = rev(pos)[i]
  # Parameters
  uid <- vulnerability$Position == k & vulnerability$nParam == 1
  dat <- vulnerability[uid, ]

  # Density
  datY <- density(dat$Sensitivity, from = -.06, to = .06)

  # Threshold
  th <- .01

  # Data range
  xR <- c(cl[4]+.025, cl[5]-.025)
  yR <- c(i+.1, i+.9)

  # Data
  maxY <- max(datY$y)
  y <- (datY$y/maxY)*.8+yR[1]
  x <- seq(xR[1]+.05, xR[2]-.05, length.out = length(y))

  # WEP+
  uid <- which(datY$x < -th)
  # envelop(x = x[uid], upper = y[uid], lower = rep(yR[1],length(uid)), col = paste0(cols[1], '77'), border = cols[1], lty = 2) # with dashed line
  envelop(x = x[uid], upper = y[uid], lower = rep(yR[1],length(uid)), col = paste0(cols[1], '77'), border = '#00000000')

  # WEP-
  uid <- which(datY$x > th)
  # envelop(x = x[uid], upper = y[uid], lower = rep(yR[1],length(uid)), col = paste0(cols[2], '77'), border = cols[2], lty = 2) # with dashed line
  envelop(x = x[uid], upper = y[uid], lower = rep(yR[1],length(uid)), col = paste0(cols[2], '77'), border = '#00000000')

  # # BS
  # uid <- which(datY$x == 0)
  # envelop(x = x[uid], upper = y[uid], lower = rep(yR[1],length(uid)), col = paste0(cols[2], '44'), border = cols[2], lty = 2)

  # Density line
  lines(x = x, y = y, lwd = 1.25)

  # Number of pathways
  text(x = xR[1]+.05, y = yR[2]-.1, cex = .75, adj = c(0,.5),
       labels = paste0('n = ', nrow(dat)))
}


# -------------------------
# Multivariate sensitivity
# -------------------------
for(i in 1:length(pos)) {
  k = rev(pos)[i]
  # Parameters
  uid <- vulnerability$Position == k & vulnerability$nParam > 1
  dat <- vulnerability[uid, ]

  # Density
  datY <- density(dat$Sensitivity, from = -.15, to = .15)

  # Threshold
  th <- .01

  # Data range
  xR <- c(cl[5]+.025, cl[6]-.025)
  yR <- c(i+.1, i+.9)

  # Data
  maxY <- max(datY$y)
  y <- (datY$y/maxY)*.8+yR[1]
  x <- seq(xR[1]+.05, xR[2]-.05, length.out = length(y))

  # WEP+
  uid <- which(datY$x < -th)
  # envelop(x = x[uid], upper = y[uid], lower = rep(yR[1],length(uid)), col = paste0(cols[1], '77'), border = cols[1], lty = 2) # with dashed line
  envelop(x = x[uid], upper = y[uid], lower = rep(yR[1],length(uid)), col = paste0(cols[1], '77'), border = '#00000000')

  # WEP-
  uid <- which(datY$x > th)
  # envelop(x = x[uid], upper = y[uid], lower = rep(yR[1],length(uid)), col = paste0(cols[2], '77'), border = cols[2], lty = 2) # with dashed line
  envelop(x = x[uid], upper = y[uid], lower = rep(yR[1],length(uid)), col = paste0(cols[2], '77'), border = '#00000000')

  # # BS
  # uid <- which(datY$x == 0)
  # envelop(x = x[uid], upper = y[uid], lower = rep(yR[1],length(uid)), col = paste0(cols[2], '44'), border = cols[2], lty = 2)

  # Density line
  lines(x = x, y = y, lwd = 1.25)

  # Number of pathways
  text(x = xR[1]+.05, y = yR[2]-.1, cex = .75, adj = c(0,.5),
       labels = paste0('n = ', nrow(dat)))
}


# -------------------------
#      Amplification
# -------------------------
for(i in 1:length(pos)) {
  k = rev(pos)[i]
  # Parameters
  uid <- vulnerability$Position == k & vulnerability$nParam > 1
  dat <- vulnerability[uid, ]

  # Density
  datY <- density(dat$Amplification, from = -.005, to = .005)
  datY$y = 120 * datY$y

  # Threshold
  th <- .0002

  # Data range
  xR <- c(cl[6]+.025, cl[7]-.025)
  yR <- c(i+.1, i+.9)

  # Data
  if (!k %in% c('dix','paz')) {
    maxY <- max(datY$y)
    y <- (datY$y/maxY)*.8+yR[1]
    x <- seq(xR[1]+.05, xR[2]-.05, length.out = length(y))

    # WEP+
    uid <- which(datY$x < -th)
    # envelop(x = x[uid], upper = y[uid], lower = rep(yR[1],length(uid)), col = paste0(cols[3], '77'), border = cols[3], lty = 2) # with dashed border
    envelop(x = x[uid], upper = y[uid], lower = rep(yR[1],length(uid)), col = paste0(cols[3], '77'), border = '#00000000')

    # WEP-
    uid <- which(datY$x > th)
    # envelop(x = x[uid], upper = y[uid], lower = rep(yR[1],length(uid)), col = paste0(cols[4], '77'), border = cols[4], lty = 2) # with dashed border
    envelop(x = x[uid], upper = y[uid], lower = rep(yR[1],length(uid)), col = paste0(cols[4], '77'), border = '#00000000')

    # Density line
    lines(x = x, y = y, lwd = 1.25)
  } else {
    lines(x = rep(mean(xR),2), y = yR)
    lines(x = c(xR[1]+.05, xR[2]-.05), y = rep(yR[1],2))
  }

  # Number of pathways
  text(x = xR[1]+.05, y = yR[2]-.1, cex = .75, adj = c(0,.5),
       labels = paste0('n = ', nrow(dat)))

}

# -------------------------
#        Variance
# -------------------------
for(i in 1:length(pos)) {
  k = rev(pos)[i]
  # Parameters
  uid <- vulnerability$Position == k & vulnerability$nParam > 1
  dat <- vulnerability[uid, ]

  # Density
  datY <- density(dat$Variance, from = 0, to = .01)
  datY$y = 120 * datY$y

  # Data range
  xR <- c(cl[7]+.025, cl[8]-.025)
  yR <- c(i+.1, i+.9)

  # Data
  maxY <- max(datY$y)
  y <- (datY$y/maxY)*.8+yR[1]
  x <- seq(xR[1]+.05, xR[2]-.05, length.out = length(y))

  # Density line
  lines(x = x, y = y, lwd = 1.25)

  # Number of pathways
  text(x = xR[2]-.05, y = yR[2]-.1, cex = .75, adj = c(1,.5),
       labels = paste0('n = ', nrow(dat)))

}


# -------------------------
#        Legends
# -------------------------
xR <- seq(cl[4]+.25, cl[7]-.75, length.out = 4)
nm <- c('Negative weak\nentry points','Positive weak\nentry points','Biotic buffers','Biotic amplifiers')
for(i in 1:4) {
  # polygon(x = c(rep(xR[i],2), rep(xR[i]+.15, 2)), y = c(rw[16],rep(rw[16]-.15, 2), rw[16]),
          # border = cols[i], lty = 4, col = paste0(cols[i], '77')) # with dashed border
  polygon(x = c(rep(xR[i],2), rep(xR[i]+.15, 2)), y = c(rw[16],rep(rw[16]-.15, 2), rw[16]),
          border = '#00000000', col = paste0(cols[i], '77'))

  text(x = xR[i]+.2, y = rw[16]-.075, labels = nm[i], cex = .8, adj = c(0,.5))
}

dev.off()
