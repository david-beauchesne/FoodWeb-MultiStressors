speciesVulnerability <- function(foodWeb, stressSources, triadFreq = F) {
  # ------------------------------------------------
  # Data
  # ------------------------------------------------
  # Disturbance data
  distSL <- read.table('./Data/FoodWeb/disturbances0.txt', sep = '\t', header = T, stringsAsFactors = F)

  # Load sensitivity & amplification
  load('./Data/vulnerability.RData')

  # Modify r for r_x -> should be done much sooner in the code hierarchy
  vulnerability$Pathways <- gsub('r$', 'r_x', vulnerability$Pathways)


  # ------------------------------------------------
  # ID simulated pathways of effect
  # ------------------------------------------------
  # Parameters disturbed in simulations
  param <- c('r_x','r_y','r_z','m_y','m_z','beta','delta','gamma','mu','nu','omega')
  nP <- length(param)

  # Pathways
  simulatedPathways <- matrix(FALSE, nrow = nrow(vulnerability), ncol = nP,
                     dimnames = list(c(), param)) %>%
              as.data.frame()

  # Identify pathways of effect
  for(i in 1:nrow(vulnerability)) {
    dat <- str_split(vulnerability$Pathways[i],'-') %>% unlist()
    simulatedPathways[i, dat] <- T
  }

  # Add additional info to pathways
  simulatedPathways <- cbind(vulnerability, simulatedPathways)

  # ------------------------------------------------
  #             Triad pathways of effects
  # ------------------------------------------------
  # Triad classification
  triadClass <- triadClassification(foodWeb)

  # Empirical pathways data.frame
  empiricalPathways <- matrix(FALSE, nrow = nrow(triadClass), ncol = nP,
                              dimnames = list(c(), param)) %>%
                       as.data.frame()

  # Evaluate pathway of effect for each triad
  for(i in 1:nrow(triadClass)) {
    # Motif
    motif <- colnames(triadClass)[1:4][triadClass[i, 1:4] == 1]

    # Data.frame to store empirical effects from impacts matrix
    impact <- data.frame(position = c('x','y','z'),
                         species = as.character(triadClass[i, 5:7]),
                         mortality = logical(3), physiology = logical(3),
                         behavior = logical(3))

    # Effects
    for(j in 1:3) {
      dat <- distSL[distSL$Group == impact$species[j], stressSources]
      impact$mortality[j] <- 'm' %in% dat
      impact$physiology[j] <- 'p' %in% dat
      impact$behavior[j] <- 'b' %in% dat
    }

    # !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    #
    # We will play with these rules for now
    # Impacts on species mortality affects resource growth and mortality pathways (r_x, r_y, r_z, m_y, m_z)
    # Impacts on resource and consumer behavior affects the attack rates of the consumers (beta, delta, gamma)
    # Impacts on resource and consumer physiology effects the conversion rate of consumers (mu, nu, omega)
    #
    # !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!


    # Evaluate per motif
    # Tri-trophic food chain
    if (motif == 'tt') {
      if (impact$mortality[1]) empiricalPathways$r_x[i] <- T                                 # Resource growth
      if (impact$mortality[2]) empiricalPathways$m_y[i] <- T                                 # Meso-predator mortality
      if (impact$mortality[3]) empiricalPathways$m_z[i] <- T                                 # Predator mortality
      if (impact$behavior[2] | impact$behavior[1]) empiricalPathways$beta[i] <- T            # Meso-predator attack rate
      if (impact$behavior[3] | impact$behavior[2]) empiricalPathways$delta[i] <- T           # Predator attack rate
      if (impact$physiology[2] | impact$physiology[1]) empiricalPathways$mu[i] <- T          # Meso-predator conversion rate
      if (impact$physiology[3] | impact$physiology[2]) empiricalPathways$omega[i] <- T       # Predator conversion rate
    }

    # Omnivory
    if (motif == 'om') {
      if (impact$mortality[1]) empiricalPathways$r_x[i] <- T                                 # Resource growth
      if (impact$mortality[2]) empiricalPathways$m_y[i] <- T                                 # Meso-predator mortality
      if (impact$mortality[3]) empiricalPathways$m_z[i] <- T                                 # Predator mortality
      if (impact$behavior[2] | impact$behavior[1]) empiricalPathways$beta[i] <- T            # Meso-predator attack rate
      if (impact$behavior[3] | impact$behavior[2]) empiricalPathways$delta[i] <- T           # Predator attack rate on meso-predator
      if (impact$behavior[3] | impact$behavior[1]) empiricalPathways$gamma[i] <- T           # Predator attack rate on resource
      if (impact$physiology[2] | impact$physiology[1]) empiricalPathways$mu[i] <- T          # Meso-predator conversion rate
      if (impact$physiology[3] | impact$physiology[2]) empiricalPathways$omega[i] <- T       # Predator conversion rate of meso-predator
      if (impact$physiology[3] | impact$physiology[1]) empiricalPathways$nu[i] <- T          # Predator conversion rate of resource
    }

    # Exploitative competition
    if (motif == 'ex') {
      if (impact$mortality[1]) empiricalPathways$r_x[i] <- T                                 # Resource growth
      if (impact$mortality[2]) empiricalPathways$m_y[i] <- T                                 # Meso-predator mortality
      if (impact$mortality[3]) empiricalPathways$m_z[i] <- T                                 # Predator mortality
      if (impact$behavior[2] | impact$behavior[1]) empiricalPathways$beta[i] <- T            # Meso-predator attack rate
      if (impact$behavior[3] | impact$behavior[1]) empiricalPathways$gamma[i] <- T           # Predator attack rate
      if (impact$physiology[2] | impact$physiology[1]) empiricalPathways$mu[i] <- T          # Meso-predator conversion rate
      if (impact$physiology[3] | impact$physiology[1]) empiricalPathways$nu[i] <- T          # Predator conversion rate
    }

    # Apparent competition
    if (motif == 'ap') {
      if (impact$mortality[1]) empiricalPathways$r_x[i] <- T                                 # Resource x growth
      if (impact$mortality[2]) empiricalPathways$r_y[i] <- T                                 # Resource y growth
      if (impact$mortality[3]) empiricalPathways$m_z[i] <- T                                 # Predator mortality
      if (impact$behavior[3] | impact$behavior[2]) empiricalPathways$delta[i] <- T           # Predator attack rate on resource y
      if (impact$behavior[3] | impact$behavior[1]) empiricalPathways$gamma[i] <- T           # Predator attack rate on resource x
      if (impact$physiology[3] | impact$physiology[2]) empiricalPathways$omega[i] <- T       # Predator conversion rate of resource y
      if (impact$physiology[3] | impact$physiology[1]) empiricalPathways$nu[i] <- T          # Predator conversion rate of resource x
    }
  }

  # Add empirical pathways to triad classification (might not be useful)
  triadClass <- cbind(triadClass, empiricalPathways)


  # Transform triad classification to have 1 row per species per triad
  triadClass <- triadClass %>%
                gather(position, species, -tt, -om, -ap, -ex, -r_x, -r_y, -r_z,
                                          -m_y, -m_z, -beta, -delta, -gamma,
                                          -mu, -nu, -omega) %>%
                gather(motif, value, -position, -species, -r_x, -r_y, -r_z,
                                     -m_y, -m_z, -beta, -delta, -gamma, -mu,
                                     -nu, -omega) %>%
                filter(value == 1) %>%
                mutate(position = paste0(motif, position)) %>%
                select(-value)

  # Species sensitivity & amplification
  triadClass$Amplification <- triadClass$Sensitivity <- 0

  # Evaluate sensitivity & amplification per triad classification as a function of pathway of effect
  for(i in 1:nrow(triadClass)) {
    # Parameters
    dat <- triadClass[i, param]
    motif <- triadClass$motif[i]
    pos <- triadClass$position[i]

    # Locate in simulated sensitivity dataset - check conditions
    uid <- which(simulatedPathways$Motif == motif &
                 simulatedPathways$Position == pos &
                 simulatedPathways$r_x == dat$r_x &
                 simulatedPathways$r_y == dat$r_y &
                 simulatedPathways$r_z == dat$r_z &
                 simulatedPathways$m_y == dat$m_y &
                 simulatedPathways$m_z == dat$m_z &
                 simulatedPathways$beta == dat$beta &
                 simulatedPathways$delta == dat$delta &
                 simulatedPathways$gamma == dat$gamma &
                 simulatedPathways$mu == dat$mu &
                 simulatedPathways$nu == dat$nu &
                 simulatedPathways$omega == dat$omega)

    # sensitivity & amplification
    if (length(uid) == 1) {
      triadClass$Sensitivity[i] <- simulatedPathways$Sensitivity[uid]
      triadClass$Amplification[i] <- simulatedPathways$Amplification[uid]
    }
}

  # Add pathways frequency
  triadClass$pathFreq <- apply(triadClass[, param], 1, any)


  # Summarize by species
  if (!triadFreq) {
    speciesVulnerability <- triadClass %>%
                            select(species, Sensitivity, Amplification) %>%
                            group_by(species) %>%
                            summarize(Sensitivity = sum(Sensitivity, na.rm = T),
                                      Amplification = sum(Amplification, na.rm = T)) %>%
                            arrange(Sensitivity)
  }
  if (triadFreq) {
    speciesVulnerability <- triadClass %>%
                            select(species, Sensitivity, Amplification, pathFreq) %>%
                            group_by(species) %>%
                            summarize(Sensitivity = sum(Sensitivity, na.rm = T),
                                      Amplification = sum(Amplification, na.rm = T),
                                      PathwayFrequency = sum(pathFreq)) %>%
                            arrange(Sensitivity)
  }


  # Return
  return(speciesVulnerability)
}
