# source('./Code/15-PositionVulnerability.R')
source('./Code/0-Param.R')
# Sensitivity
load('./Data/DisturbancesAll.RData')
sensPos <- int %>%
           group_by(position) %>%
           summarise(Med = median(delta),
                     Mean = mean(delta),
                     SD = sd(delta),
                     SE = SD/sqrt(n()),
                     CIp = Mean + (1.96*SE),
                     CIm = Mean - (1.96*SE)) %>%
           arrange(position)


# Amplification
load('./Data/AdditiveAll.RData')
ampPos <- intAdd %>%
          group_by(position) %>%
          summarise(Med = median(Int),
                    Mean = mean(Int),
                    SD = sd(Int),
                    SE = SD/sqrt(n()),
                    CIp = Mean + (1.96*SE),
                    CIm = Mean - (1.96*SE)) %>%
          arrange(position)

# Thresholds
ampTh <- .0002
sensTh <- .01

# Plot
png('./Figures/positionVulnerability.png', width = 1500, height = 1500, res = 200, pointsize = 12)
par(mar = c(5,5,2,2), family = 'serif')
xR <- c(-.0004,.0004)
yR <- c(-.06, .06)
plot0(x = xR, y = yR)
ext <- par('usr')
axis(1, cex.axis = .9)
axis(2, cex.axis = .9)
axis(3, cex.axis = .9)
axis(4, cex.axis = .9)
box(lwd = 2)
abline(h=0, lty = 2, lwd = 2)
abline(v=0, lty = 2, lwd = 2)

# Buffers, amplifiers, weak entry points
polygon(x = ext[c(1,2,2,1)], y = c(rep(-sensTh,2), ext[c(3,3)]), col = paste0(cols[1], '22'), border = 'transparent')
polygon(x = ext[c(1,2,2,1)], y = c(rep(sensTh,2), ext[c(4,4)]), col = paste0(cols[1], '22'), border = 'transparent')
polygon(y = ext[c(3,4,4,3)], x = c(rep(ampTh,2), ext[c(4,4)]), col = paste0(cols[2], '22'), border = 'transparent')
polygon(y = ext[c(3,4,4,3)], x = c(rep(-ampTh,2), ext[c(3,3)]), col = paste0(cols[2], '22'), border = 'transparent')
abline(v = ampTh, lty = 4, col = cols[2], lwd = 2)
abline(v = -ampTh, lty = 4, col = cols[2], lwd = 2)
abline(h = sensTh, lty = 4, col = cols[1], lwd = 2)
abline(h = -sensTh, lty = 4, col = cols[1], lwd = 2)
text(x = ext[1]-ext[1]*.025, y = sensTh+sensTh*.1, adj = c(0,0), labels = 'Weak entry points', cex = .8, col = cols[1], font = 2)
text(x = ext[1]-ext[1]*.025, y = -sensTh-sensTh*.1, adj = c(0,1), labels = 'Weak entry points', cex = .8, col = cols[1], font = 2)
text(x = ampTh+ampTh*.05, y = ext[4]-ext[4]*.025, adj = c(0,1), labels = 'Biotic amplifiers', cex = .8, col = cols[2], font = 2)
text(x = -ampTh-ampTh*.05, y = ext[4]-ext[4]*.025, adj = c(1,1), labels = 'Biotic buffers', cex = .8, col = cols[2], font = 2)

# Axes title
mtext(text = TeX('Mean $\\s_i$ $\\pm$ 95% CI'), side = 2, line = 2.25, cex = 1)
mtext(text = TeX('Mean $\\A_i$ $\\pm$ 95% CI'), side = 1, line = 2.25, cex = 1)
mtext(text = TeX('\\textbf{Position sensitivity} ($S_i$)'), side = 2, line = 3.5, cex = 1.25)
mtext(text = TeX('\\textbf{Position amplification} ($A_i$)'), side = 1, line = 3.5, cex = 1.25)

# Data
# Motifs
# Data frame to position motif on figure
dat <- data.frame(motif = substr(ampPos$position,1,2),
                  position = substr(ampPos$position,3,3),
                  x = ampPos$Mean, y = sensPos$Mean,
                  xM = 0, yM = 0, xL = 0, yL = 0,
                  stringsAsFactors = F)

# This'll be ugly!
# X
dat$xM[1] <- dat$x[1] - .000025
dat$xM[2] <- dat$x[2] - .00006
dat$xM[3] <- dat$x[3] + .00005
dat$xM[4] <- dat$x[4] - .00004
dat$xM[5] <- dat$x[5] - .00004
dat$xM[6] <- dat$x[6] + .00002
dat$xM[7] <- dat$x[7] + .00005
dat$xM[8] <- dat$x[8] - .00005
dat$xM[9] <- dat$x[9] + .00004
dat$xM[10] <- dat$x[10] - .00005
dat$xM[11] <- dat$x[11] + .00003
dat$xM[12] <- dat$x[12] - .00004
dat$xM[13] <- dat$x[13] - .00004
dat$xM[14] <- dat$x[14] - .00005

# Y
dat$yM[1] <- dat$y[1] + .01
dat$yM[2] <- dat$y[2] - .004
dat$yM[3] <- dat$y[3] - .009
dat$yM[4] <- dat$y[4]
dat$yM[5] <- dat$y[5] - .008
dat$yM[6] <- dat$y[6] - .008
dat$yM[7] <- dat$y[7] + .002
dat$yM[8] <- dat$y[8] - .001
dat$yM[9] <- dat$y[9] + .002
dat$yM[10] <- dat$y[10] + .005
dat$yM[11] <- dat$y[11] + .002
dat$yM[12] <- dat$y[12] - .002
dat$yM[13] <- dat$y[13] - .003
dat$yM[14] <- dat$y[14] + .003


# Line X
dat$xL[1] <- dat$xM[1] - .0000125
dat$xL[2] <- dat$xM[2]
dat$xL[3] <- dat$xM[3]
dat$xL[4] <- dat$xM[4]
dat$xL[5] <- dat$xM[5] - .0000125
dat$xL[6] <- dat$xM[6] + .0000125
dat$xL[7] <- dat$xM[7] - .0000125
dat$xL[8] <- dat$xM[8] + .0000125
dat$xL[9] <- dat$xM[9]
dat$xL[10] <- dat$xM[10]
dat$xL[11] <- dat$xM[11]
dat$xL[12] <- dat$xM[12]
dat$xL[13] <- dat$xM[13]
dat$xL[14] <- dat$xM[14]

# Line Y
dat$yL[1] <- dat$yM[1] - .003
dat$yL[2] <- dat$yM[2] + .003
dat$yL[3] <- dat$yM[3] - .003
dat$yL[4] <- dat$yM[4] - .003
dat$yL[5] <- dat$yM[5] + .003
dat$yL[6] <- dat$yM[6] - .003
dat$yL[7] <- dat$yM[7] + .001
dat$yL[8] <- dat$yM[8] + .003
dat$yL[9] <- dat$yM[9]
dat$yL[10] <- dat$yM[10] - .003
dat$yL[11] <- dat$yM[11] + .003
dat$yL[12] <- dat$yM[12] - .003
dat$yL[13] <- dat$yM[13]
dat$yL[14] <- dat$yM[14] + .003



for(i in 1:nrow(dat)) {
  # Lines
  lines(x = c(dat$x[i], dat$xL[i]), y = c(dat$y[i], dat$yL[i]), lty = 2, lwd = 1.5, col = '#00000077')

  # Motifs
  plotMotifs(motif = dat$motif[i], position = dat$position[i],
             x = dat$xM[i], y = dat$yM[i],
             scalingX = .00003, scalingY = .003,
             posCol = '#818181', colLine = '#afacac',
             cex = .9, lwd2 = 3, lwd = .75, add = T)
}

# Mean position values
points(x = ampPos$Mean, y = sensPos$Mean, pch = 21, cex = 1.25, bg = '#e98181', col = '#8e4747', lwd = 2.5)
# points(x = ampPos$Mean, y = sensPos$Mean, pch = 21, cex = 1.25, bg = '#00000022', col = '#00000044', lwd = 3)
# points(x = ampPos$Mean[i], y = sensPos$Mean[i], pch = 21, cex = 1.25, bg = '#7a7a7a', col = '#000000', lwd = 3)

dev.off()
