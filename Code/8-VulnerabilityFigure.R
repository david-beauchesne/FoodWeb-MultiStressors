# source('./Code/8-VulnerabilityFigure.R')
source('./Code/0-Param.R')
load('./Data/AdditivePath.RData')
load('./Data/UnivariatePath.RData')
load('./Data/MultivariatePath.RData')
source('./Functions/plotMotifs.R')

# ------------------------------------------------------------------------------
#                                 FIGURE 3
# ------------------------------------------------------------------------------
# Parameters
pos <- c('ttz','tty','ttx','omz','omy','omx','exz','exx','apz','apx','paz','pax','pay','dix')
sep <- c('ttx','omx','exx','apx','pay')

png('./Figures/vulnerability.png', width = 1120, height = 1500, res = 200, pointsize = 6)
# layout(mat, widths = c(.55,.35,1,1), heights = c(.5,rep(1,14)))
par(family = 'serif')

cl <- c(0,.55,.9,1,2,3,4)
rw <- c(0,seq(.5, by = 1, length.out = 16)) %>% rev()

# Plot 1
par(mar = c(0,0,0,0))
plot0(x = c(0,3.9), y = c(.5,15.5))

# -------------------------
#        Titles
# -------------------------
text(x = mean(cl[1:2]), y = rw[1]+.1, labels = 'Motifs', adj = c(.5,.5), cex = 1.25, font = 2)
text(x = mean(cl[2:3]), y = rw[1]+.1, labels = 'Positions', adj = c(.5,.5), cex = 1.25, font = 2)
text(x = mean(cl[4:6]), y = rw[1]+.2, labels = TeX('\\textbf{Trophic sensitivity} ($S_{i,j}$)'), cex = 1.25, adj = c(.5,.5))
text(x = mean(cl[4:6]), y = rw[1], labels = TeX('Mean $\\s_{i,j}$ $\\pm$ 95% CI'), cex = 1, adj = c(.5,.5))

text(x = mean(cl[4:5]), y = rw[1]-.3, labels = TeX('\\textbf{Univariate pathways}'), cex = 1, adj = c(.5,.5))
text(x = mean(cl[5:6]), y = rw[1]-.3, labels = TeX('\\textbf{Multivariate pathways}'), cex = 1, adj = c(.5,.5))

text(x = mean(cl[6:7]), y = rw[1]+.2, labels = TeX('\\textbf{Trophic amplification} ($A_{i,j}$)'), cex = 1.25, adj = c(.5,.5))
text(x = mean(cl[6:7]), y = rw[1], labels = TeX('Mean $\\A_{i,j}$ $\\pm$ 95% CI'), cex = 1, adj = c(.5,.5))


# -------------------------
#        Motifs
# -------------------------
motifs <- c('tt','om','ex','ap','pa','di')
posY <- c(15,12,9,7,5,2)
lab <- c('Tri-trophic\nchain','Omnivory','Exploitative\ncompetition','Apparent\ncompetition','Partially\nconnected','Disconnected')
for(i in 1:length(motifs)) {
  plotMotifs(motifs[i], scalingY = .3, scalingX = .15, x = cl[2]-.1, y = posY[i]-.5, add = T, cex = 1.5)
  text(x = 0, y = posY[i]-.1, labels = lab[i], cex = 1, adj = c(0,1))
}


# -------------------------
#       Positions
# -------------------------
motifs <- c('tt','tt','tt','om','om','om','ex','ex','ap','ap','pa','pa','pa','di') %>% rev()
sp <- c('z','y','x','z','y','x','z','x','z','x','z','x','y','x') %>% rev()
for(i in 1:length(motifs)) {
  plotMotifs(motifs[i], sp[i], add = T, cex = 1.5,
             scalingY = .3, scalingX = .15,
             x = mean(cl[2:3]), y = i+.5)
}

# -------------------------
#  Univariate sensitivity
# -------------------------
for(i in 1:length(pos)) {
  k = rev(pos)[i]
  # Parameters
  uid <- uniPath$position == k
  dat <- uniPath[uid, ]

  # Thresholds - sensitivity
  th <- .01
  idA1 <- which(round(dat$Mean,6) < -th) %>% { if(length(.) > 0) max(.) else NULL }
  idA2 <- which(round(dat$Mean,6) > th) %>% { if(length(.) > 0) min(.) else NULL }
  idA3 <- which(round(dat$Mean,6) == 0) %>% { if(length(.) > 0) range(.) else NULL }

  # Axes
  xR <- c(cl[4]+.1, cl[5]-.1)
  arrows(xR[1], i+.5, xR[2], i+.5, length = .05, code = 2, xpd = TRUE)
  text(x = xR[2], y = i+.35, labels = 'Rank', adj = c(1,.5), cex = .75)
  lines(x = rep(xR[1],2), y = c(i+.1, i+.9), lwd = 1.25)
  y <- seq(i+.1,i+.9,length.out = 5)
  x <- c('-0.150','-0.075','0.000','0.075','0.150')
  for(j in 1:5) {
    lines(x = c(xR[1], xR[1]-.02), y = rep(y[j],2), lwd = 1.25)
    text(x = xR[1]-.05, y = y[j], labels = x[j], cex = .75, adj = c(1,.5))
  }

  # Thresholds
  datX <- seq(xR[1]+.05, xR[2]-.05, length.out = nrow(dat))
  if (!is.null(idA3)) {
    xMin <- ifelse(idA3[1] == 1, datX[1], datX[idA3][1]-diff(datX[1:2])/2.25)
    xMax <- ifelse(idA3[2] == nrow(dat), last(datX), datX[idA3][2]+diff(datX[1:2])/2.25)
    if(xMin != datX[1]) lines(x = rep(xMin,2), y = c(i+.1, i+.9), lty = 4, col = cols[1])
    if(xMax != last(datX)) lines(x = rep(xMax,2), y = c(i+.1, i+.9), lty = 4, col = cols[1])
    polygon(x = c(xMin, rep(xMax,2), xMin),
            y = c(i+.1, i+.1, i+.9, i+.9), border = 'transparent', col = paste0(cols[1], '11'))
  }
  if (!is.null(idA1)) {
    lines(x = rep(datX[idA1]+(diff(datX[1:2])/2.25),2), y = c(i+.1, i+.9), lty = 4, col = cols[2])
    polygon(x = c(datX[1], datX[1], rep(datX[idA1]+(diff(datX[1:2])/2.25),2)),
            y = c(i+.1, i+.9, i+.9, i+.1), border = 'transparent', col = paste0(cols[2], '11'))
  }
  if (!is.null(idA2)) {
    lines(x = rep(datX[idA2]-(diff(datX[1:2])/2.25),2), y = c(i+.1, i+.9), lty = 4, col = cols[2])
    polygon(x = c(rep(datX[length(datX)],2), rep(datX[idA2]-(diff(datX[1:2])/2.25),2)),
            y = c(i+.1, i+.9, i+.9, i+.1), border = 'transparent', col = paste0(cols[2], '11'))
  }

  # Data
  datY <- (dat$Mean/.15)/2+i+.5
  datCIm <- (dat$CIm/.15)/2+i+.5
  datCIp <- (dat$CIp/.15)/2+i+.5
  envelop(x = datX, upper = datCIp, lower = datCIm, col = paste0(cols[1],'44'), border = '#00000000')
  lines(x = datX, y = datY, col = cols[1], lwd = 1.5)
}


# -------------------------
# Multivariate sensitivity
# -------------------------
for(i in 1:length(pos)) {
  k = rev(pos)[i]
  # Parameters
  uid <- multiPath$position == k
  dat <- multiPath[uid, ]

  # Thresholds - sensitivity
  th <- .01
  idA1 <- which(round(dat$Mean,6) < -th) %>% { if(length(.) > 0) max(.) else NULL }
  idA2 <- which(round(dat$Mean,6) > th) %>% { if(length(.) > 0) min(.) else NULL }
  idA3 <-which(round(dat$Mean,6) == 0) %>% { if(length(.) > 0) range(.) else NULL }

  # Axes
  xR <- c(cl[5]+.1, cl[6]-.1)
  arrows(xR[1], i+.5, xR[2], i+.5, length = .05, code = 2, xpd = TRUE)
  text(x = xR[2], y = i+.35, labels = 'Rank', adj = c(1,.5), cex = .75)
  lines(x = rep(xR[1],2), y = c(i+.1, i+.9), lwd = 1.25)
  y <- seq(i+.1,i+.9,length.out = 5)
  x <- c('-0.150','-0.075','0.000','0.075','0.150')
  for(j in 1:5) {
    lines(x = c(xR[1], xR[1]-.02), y = rep(y[j],2), lwd = 1.25)
    text(x = xR[1]-.05, y = y[j], labels = x[j], cex = .75, adj = c(1,.5))
  }

  # Thresholds
  datX <- seq(xR[1]+.05, xR[2]-.05, length.out = nrow(dat))
  if (!is.null(idA3)) {
    xMin <- ifelse(idA3[1] == 1, datX[1], datX[idA3][1]-diff(datX[1:2])/2.25)
    xMax <- ifelse(idA3[2] == nrow(dat), last(datX), datX[idA3][2]+diff(datX[1:2])/2.25)
    if(xMin != datX[1]) lines(x = rep(xMin,2), y = c(i+.1, i+.9), lty = 4, col = cols[1])
    if(xMax != last(datX)) lines(x = rep(xMax,2), y = c(i+.1, i+.9), lty = 4, col = cols[1])
    polygon(x = c(xMin, rep(xMax,2), xMin),
            y = c(i+.1, i+.1, i+.9, i+.9), border = 'transparent', col = paste0(cols[1], '11'))
  }
  if (!is.null(idA1)) {
    lines(x = rep(datX[idA1]+(diff(datX[1:2])/2.25),2), y = c(i+.1, i+.9), lty = 4, col = cols[2])
    polygon(x = c(datX[1], datX[1], rep(datX[idA1]+(diff(datX[1:2])/2.25),2)),
            y = c(i+.1, i+.9, i+.9, i+.1), border = 'transparent', col = paste0(cols[2], '11'))
  }
  if (!is.null(idA2)) {
    lines(x = rep(datX[idA2]-(diff(datX[1:2])/2.25),2), y = c(i+.1, i+.9), lty = 4, col = cols[2])
    polygon(x = c(rep(datX[length(datX)],2), rep(datX[idA2]-(diff(datX[1:2])/2.25),2)),
            y = c(i+.1, i+.9, i+.9, i+.1), border = 'transparent', col = paste0(cols[2], '11'))
  }

  # Data
  datY <- (dat$Mean/.15)/2+i+.5
  datCIm <- (dat$CIm/.15)/2+i+.5
  datCIp <- (dat$CIp/.15)/2+i+.5
  envelop(x = datX, upper = datCIp, lower = datCIm, col = paste0(cols[1],'44'), border = '#00000000')
  lines(x = datX, y = datY, col = cols[1], lwd = 1.5)
}


# -------------------------
#      Amplification
# -------------------------
for(i in 1:length(pos)) {
  k = rev(pos)[i]
  # Parameters
  uid <- addPath$position == k
  dat <- addPath[uid, ]

  # Thresholds - amplification
  th <- .0002
  idA1 <- which(round(dat$Mean,6) <= -th) %>% { if(length(.) > 0) max(.) else NULL }
  idA2 <- which(round(dat$Mean,6) >= th) %>% { if(length(.) > 0) min(.) else NULL }

  # Axes
  xR <- c(cl[6]+.1, cl[7]-.1)
  arrows(xR[1], i+.5, xR[2], i+.5, length = .05, code = 2, xpd = TRUE)
  text(x = xR[2], y = i+.35, labels = 'Rank', adj = c(1,.5), cex = .75)
  lines(x = rep(xR[1],2), y = c(i+.1, i+.9), lwd = 1.25)
  y <- seq(i+.1,i+.9,length.out = 5)
  x <- c('-0.0050','-0.0025','0.0000','0.0025','0.0050')
  for(j in 1:5) {
    lines(x = c(xR[1], xR[1]-.02), y = rep(y[j],2), lwd = 1.25)
    text(x = xR[1]-.05, y = y[j], labels = x[j], cex = .75, adj = c(1,.5))
  }

  # Thresholds
  datX <- seq(xR[1]+.05, xR[2]-.05, length.out = nrow(dat))
  if (!is.null(idA1)) {
    lines(x = rep(datX[idA1]+(diff(datX[1:2])/2),2), y = c(i+.1, i+.9), lty = 4, col = cols[1])
    polygon(x = c(datX[1], datX[1], rep(datX[idA1]+(diff(datX[1:2])/2),2)),
            y = c(i+.1, i+.9, i+.9, i+.1), border = 'transparent', col = paste0(cols[1], '11'))
  }
  if (!is.null(idA2)) {
    lines(x = rep(datX[idA2]-(diff(datX[1:2])/2),2), y = c(i+.1, i+.9), lty = 4, col = cols[2])
    polygon(x = c(rep(datX[length(datX)],2), rep(datX[idA2]-(diff(datX[1:2])/2),2)),
            y = c(i+.1, i+.9, i+.9, i+.1), border = 'transparent', col = paste0(cols[2], '11'))
  }

  # Data
  datY <- (dat$Mean/.005)/2+i+.5
  datCIm <- (dat$CIm/.005)/2+i+.5
  datCIp <- (dat$CIp/.005)/2+i+.5
  envelop(x = datX, upper = datCIp, lower = datCIm, col = paste0(cols[1],'44'), border = '#00000000')
  lines(x = datX, y = datY, col = cols[1], lwd = 1.5)
}



# -------------------------
#        Legends
# -------------------------
# Trophic amplification
xR <- c(cl[5]+.1, cl[6]-.1)
polygon(x = c(rep(xR[1],2), rep(xR[1]+.15, 2)), y = c(rw[16],rep(rw[16]-.15, 2), rw[16]),
        border = cols[1], lty = 4, col = paste0(cols[1], '11'))
polygon(x = c(rep(xR[1],2), rep(xR[1]+.15, 2)), y = c(rw[16]-.25,rep(rw[16]-.4, 2), rw[16]-.25),
        border = cols[2], lty = 4, col = paste0(cols[2], '11'))
text(x = xR[1]+.2, y = rw[16]-.075, labels = 'Biotic sinks', cex = .8, adj = c(0,.5))
text(x = xR[1]+.2, y = rw[16]-.325, labels = 'Weak entry point', cex = .8, adj = c(0,.5))


# Position amplification
xR <- c(cl[6]+.1, cl[7]-.1)
polygon(x = c(rep(xR[1],2), rep(xR[1]+.15, 2)), y = c(rw[16],rep(rw[16]-.15, 2), rw[16]),
        border = cols[1], lty = 4, col = paste0(cols[1], '11'))
polygon(x = c(rep(xR[1],2), rep(xR[1]+.15, 2)), y = c(rw[16]-.25,rep(rw[16]-.4, 2), rw[16]-.25),
        border = cols[2], lty = 4, col = paste0(cols[2], '11'))
text(x = xR[1]+.2, y = rw[16]-.075, labels = 'Biotic buffer', cex = .8, adj = c(0,.5))
text(x = xR[1]+.2, y = rw[16]-.325, labels = 'Biotic amplifier', cex = .8, adj = c(0,.5))


dev.off()
